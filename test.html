<!doctype html>
<html lang="pt-br">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Consulta de Compra por Número — UASG 925467</title>
  <style>
    :root{
      --bg:#0b1020; --card:#121833; --muted:#9aa4bf; --text:#e8ecf6; --accent:#7aa2ff; --ok:#73d13d; --err:#ff7875;
    }
    *{box-sizing:border-box}
    body{font-family:system-ui, -apple-system, Segoe UI, Roboto, Inter, Ubuntu, Cantarell, "Helvetica Neue", Arial, "Noto Sans", sans-serif; margin:0; background:var(--bg); color:var(--text)}
    .wrap{max-width:1100px; margin:40px auto; padding:0 16px}
    .card{background:linear-gradient(180deg, rgba(255,255,255,0.04), rgba(255,255,255,0.02)); border:1px solid rgba(255,255,255,0.08); border-radius:16px; box-shadow:0 10px 30px rgba(0,0,0,.25)}
    header.card{padding:20px}
    header h1{font-size:22px; margin:0 0 6px}
    header p{margin:0; color:var(--muted); font-size:14px}
    form{display:flex; gap:12px; flex-wrap:wrap; padding:16px}
    input, button, select{height:42px; border-radius:10px; border:1px solid rgba(255,255,255,0.14); background:#0f1530; color:var(--text); padding:0 12px}
    input::placeholder{color:#7d86a6}
    button{cursor:pointer; background:linear-gradient(180deg, #2a4cff, #1636b8); border:none}
    button:disabled{opacity:.5; cursor:not-allowed}
    small.hint{display:block; color:var(--muted); margin-top:8px}
    details{background:transparent; border:none; margin:12px 0}
    details > summary{cursor:pointer; color:var(--accent)}
    .grid{display:grid; grid-template-columns:repeat(12,1fr); gap:16px; padding:16px}
    .col-12{grid-column:span 12}
    .col-6{grid-column:span 6}
    .panel{padding:16px; border:1px solid rgba(255,255,255,0.08); border-radius:14px; background:var(--card)}
    .panel h3{margin:0 0 8px; font-size:16px}
    pre{white-space:pre-wrap; word-wrap:break-word; background:#0c122a; padding:12px; border-radius:10px; overflow:auto; max-height:480px}
    code{font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", monospace}
    .tag{display:inline-block; padding:2px 8px; border-radius:999px; background:#0c122a; color:#aab3d3; border:1px solid rgba(255,255,255,0.08); font-size:12px}
    .ok{color:var(--ok)} .err{color:var(--err)}
  </style>
</head>
<body>
  <div class="wrap">
    <header class="card">
      <h1>Consulta de Compra (nº completo) — <span class="tag">UASG fixa: 925467</span></h1>
      <p>Informe o <strong>número completo da compra</strong> (ex.: <code>92546705900082025</code>). A página chama os endpoints públicos do Compras.gov.br para reunir dados da compra e dos itens (materiais/serviços).<br>
      <small class="hint">Observação: os endpoints oficiais exigem <strong>CORS permitido</strong>. Se seu navegador bloquear, rode esta página num servidor local (ex.: <code>npx serve</code>) ou configure um proxy que preserve cabeçalhos.</small></p>
    </header>

    <section class="card">
      <form id="form">
        <input id="numeroCompra" name="numeroCompra" placeholder="Número da compra (ex.: 92546705900082025)" required pattern="[0-9]{17,20}" style="flex:1" />
        <button id="btnBuscar" type="submit">Buscar</button>
        <select id="apiPreset" title="Presets de API">
          <option value="oficial" selected>API oficial (dados abertos)</option>
          <option value="custom">Custom (editar abaixo)</option>
        </select>
      </form>
      <div style="padding:0 16px 16px">
        <label for="apiBase">Base da API</label>
        <input id="apiBase" style="width:100%; margin-top:6px" value="https://dadosabertos.compras.gov.br" />
        <small class="hint">Você pode trocar a base se necessário (ex.: ambientes espelhados). A página usará endpoints nos módulos <code>modulo-uasg</code> e <code>modulo-pesquisa-preco</code>.</small>
        <div style="margin-top:10px"></div>
        <label for="proxyBase">Proxy (opcional, para contornar CORS)</label>
        <input id="proxyBase" style="width:100%; margin-top:6px" placeholder="ex.: http://localhost:3000/proxy?url=" />
        <small class="hint">Se aparecer <em>Failed to fetch</em> no log, provavelmente é CORS. Rode o pequeno servidor proxy abaixo e informe aqui a URL base dele (terminando em <code>?url=</code>).</small>
      </div>
    </section>

    <section class="grid">
      <div class="col-6 panel">
        <h3>Resumo da UASG</h3>
        <div id="uasgResumo"><em class="tag">aguardando…</em></div>
      </div>
      <div class="col-6 panel">
        <h3>Status</h3>
        <div id="status"><em class="tag">pronto</em></div>
      </div>

      <div class="col-12 panel">
        <h3>Dados consolidados da compra</h3>
        <pre id="saidaCompra"><code>// execute uma busca…</code></pre>
      </div>

      <div class="col-6 panel">
        <h3>Itens (materiais)</h3>
        <pre id="saidaMateriais"><code>// vazio</code></pre>
      </div>
      <div class="col-6 panel">
        <h3>Itens (serviços)</h3>
        <pre id="saidaServicos"><code>// vazio</code></pre>
      </div>

      <div class="col-12 panel">
        <h3>Log de requisições</h3>
        <pre id="log"><code></code></pre>
      </div>
    </section>

    <details class="card" style="padding:16px">
      <summary>Como funciona (endpoints)</summary>
      <ul>
        <li><code>/modulo-uasg/1_consultarUasg</code> — carrega dados cadastrais da UASG 925467.</li>
        <li><code>/modulo-pesquisa-preco/1_consultarMaterial</code> e <code>/3_consultarServico</code> — lista itens vinculados (busca por número/UASG).</li>
        <li><code>/modulo-pesquisa-preco/2_consultarMaterialDetalhe</code> — detalha itens via <code>idCompra</code> (se disponível).</li>
      </ul>
      <small class="hint">Caso algum endpoint varie conforme ambiente/versão, ajuste o campo “Base da API”.</small>
    </details>

    <details class="card" style="padding:16px">
      <summary>Servidor proxy Node (para CORS)</summary>
      <p>Se ocorrer <strong>Failed to fetch</strong>, rode este servidor local e preencha o campo <em>Proxy</em> acima com <code>http://localhost:3000/proxy?url=</code>.</p>
      <pre><code>// server.js
import express from 'express';
import fetch from 'node-fetch';
import cors from 'cors';
const app = express();
app.use(cors());
app.get('/proxy', async (req, res) => {
  const url = req.query.url;
  if(!url) return res.status(400).json({erro:'url obrigatória'});
  try {
    const r = await fetch(url, { headers: { 'Accept':'application/json' } });
    const ct = r.headers.get('content-type') || 'application/json; charset=utf-8';
    res.set('content-type', ct);
    res.status(r.status);
    const buf = await r.arrayBuffer();
    res.send(Buffer.from(buf));
  } catch (e) {
    res.status(502).json({ erro: String(e) });
  }
});
app.listen(3000, ()=> console.log('Proxy on http://localhost:3000/proxy?url='));
// execute:  npm i express node-fetch cors  &&  node server.js</code></pre>
      <small class="hint">Esse proxy só repassa as requisições e habilita CORS para o seu navegador.</small>
    </details>

    <details class="card" style="padding:16px">
      <summary>Testes automatizados (sanidade)</summary>
      <button id="btnTests" type="button">Rodar testes</button>
      <pre id="testsOut"><code>// clique acima para rodar os testes</code></pre>
    </details>
  </div>

<script>
  // ⚠️ IMPORTANTE
  // 1) Esta página usa apenas fetch() e depende de CORS habilitado no domínio da API.
  // 2) Se algum endpoint mudar no seu ambiente, ajuste as rotas em `PATHS` abaixo.

  const UASG_FIXA = '925467';
  const els = {
    form: document.getElementById('form'),
    numeroCompra: document.getElementById('numeroCompra'),
    apiBase: document.getElementById('apiBase'),
    apiPreset: document.getElementById('apiPreset'),
    uasgResumo: document.getElementById('uasgResumo'),
    status: document.getElementById('status'),
    saidaCompra: document.getElementById('saidaCompra'),
    saidaMateriais: document.getElementById('saidaMateriais'),
    saidaServicos: document.getElementById('saidaServicos'),
    log: document.getElementById('log'),
    btnTests: document.getElementById('btnTests'),
    testsOut: document.getElementById('testsOut')
  };

  const PATHS = {
    uasg: '/modulo-uasg/1_consultarUasg',
    materiais: '/modulo-pesquisa-preco/1_consultarMaterial',
    materialDetalhe: '/modulo-pesquisa-preco/2_consultarMaterialDetalhe',
    servicos: '/modulo-pesquisa-preco/3_consultarServico',
    // endpoint de contratações por número pode não existir nos dados abertos
    contratarPorNumero: '' // desativado por padrão
  };

  function qs(params){
    const s = new URLSearchParams();
    Object.entries(params||{}).forEach(([k,v])=>{ if(v!==undefined && v!==null && v!=='') s.append(k,v) });
    return s.toString();
  }

  function buildUrl(base, path, params){
    const direct = `${base}${path}?${qs(params||{})}`;
    const proxy = (document.getElementById('proxyBase')?.value||'').trim();
    return proxy ? (proxy + encodeURIComponent(direct)) : direct;
  }

  async function fetchJSON(base, path, params){
    const finalUrl = buildUrl(base, path, params);
    log(`GET ${finalUrl}`);
    const ctl = new AbortController();
    const t = setTimeout(()=>ctl.abort(), 20000);
    try{
      const res = await fetch(finalUrl, {
        credentials: 'include',
        headers: { 'Accept': 'application/json, text/plain;q=0.9' },
        signal: ctl.signal
      });
      if(!res.ok) throw new Error(`HTTP ${res.status} ao chamar ${path}`);
      const ct = (res.headers.get('content-type')||'').toLowerCase();
      if(!ct.includes('json')){
        const text = await res.text();
        try{ return JSON.parse(text) }catch{ throw new Error(`Resposta não-JSON em ${path}`) }
      }
      return res.json();
    } catch(e){
      throw e.name === 'AbortError' ? new Error('Timeout ao chamar '+path) : e;
    } finally{
      clearTimeout(t);
    }
  }

  function log(msg){
    const t = new Date().toISOString();
    els.log.textContent += `[${t}] ${msg}\n`;
  }

  function pretty(el, data){
    el.textContent = JSON.stringify(data, null, 2);
  }

  function splitNumeroCompra(n){
    // Muitos números seguem padrão: UASG(6) + modalidade/tipo(3) + número/ano...
    // Aqui extraímos a UASG presumida e deixamos o número bruto para filtros.
    const digits = (n||'').replace(/\D+/g,'');
    const uasg = digits.slice(0,6);
    return { uasg, raw: digits };
  }

  async function carregarUASG(base){
    try{
      const data = await fetchJSON(base, PATHS.uasg, { pagina: 1, codigoUasg: UASG_FIXA, statusUasg: true });
      const item = Array.isArray(data?.conteudo) ? data.conteudo[0] : (data?.conteudo || data);
      if(item){
        els.uasgResumo.innerHTML = `<div><strong>${item.nomeUasg||item.nome||'UASG'}</strong><br>`+
          `<span class="tag">Código: ${item.codigoUasg||UASG_FIXA}</span> `+
          `<span class="tag">UF: ${item.siglaUf||item.uf||'-'}</span> `+
          `<span class="tag">Município: ${item.nomeMunicipio||item.municipio||'-'}</span></div>`;
      }else{
        els.uasgResumo.textContent = 'Não encontrado.';
      }
    }catch(e){
      els.uasgResumo.innerHTML = `<span class="err">Falha ao carregar UASG: ${e.message}</span>`;
    }
  }

  async function buscarPorNumero(base, numero){
    // 1) Opcional: tentar via módulo de contratações, se existir
    if(PATHS.contratarPorNumero){
      try{
        const data = await fetchJSON(base, PATHS.contratarPorNumero, { numeroCompra: numero, pagina: 1, tamanhoPagina: 50, codigoUasg: UASG_FIXA });
        if(data && (data.conteudo?.length || Array.isArray(data))){
          return data.conteudo || data;
        }
      }catch(e){ log(`(aviso) consulta por número em contratacoes falhou: ${e.message}`) }
    }

    // 2) Fallback: pesquisar materiais e serviços da UASG e filtrar por numeroCompra (quando o campo existir)
    const tentativas = [];
    try{
      const m = await fetchJSON(base, PATHS.materiais, { codigoUasg: UASG_FIXA, pagina: 1, tamanhoPagina: 200, numeroCompra: numero });
      tentativas.push({tipo:'materiais', data:m});
    }catch(e){ log(`(aviso) materiais: ${e.message}`) }
    try{
      const s = await fetchJSON(base, PATHS.servicos, { codigoUasg: UASG_FIXA, pagina: 1, tamanhoPagina: 200, numeroCompra: numero });
      tentativas.push({tipo:'servicos', data:s});
    }catch(e){ log(`(aviso) servicos: ${e.message}`) }

    const flatten = (payload)=> Array.isArray(payload?.conteudo) ? payload.conteudo : (Array.isArray(payload) ? payload : []);
    const agregada = tentativas.flatMap(t=> flatten(t.data).map(x=> ({...x, _fonte:t.tipo})));
    return agregada;
  }

  async function detalharMateriais(base, lista){
    const comId = lista.filter(x=> x.idCompra);
    const detalhes = [];
    for(const it of comId){
      try{
        const det = await fetchJSON(base, PATHS.materialDetalhe, { idCompra: it.idCompra });
        detalhes.push({ idCompra: it.idCompra, detalhe: det });
      }catch(e){ log(`(aviso) detalhe material idCompra=${it.idCompra}: ${e.message}`) }
    }
    return detalhes;
  }

  els.apiPreset.addEventListener('change', (e)=>{
    if(e.target.value === 'oficial'){
      els.apiBase.value = 'https://dadosabertos.compras.gov.br';
    }
  });

  els.form.addEventListener('submit', async (ev)=>{
    ev.preventDefault();
    const base = els.apiBase.value.replace(/\/$/, '');
    const numero = els.numeroCompra.value.trim();
    els.status.innerHTML = '<span class="tag">consultando…</span>';
    els.saidaCompra.textContent = '// carregando…';
    els.saidaMateriais.textContent = '// carregando…';
    els.saidaServicos.textContent = '// carregando…';

    try{
      await carregarUASG(base);
      const { uasg } = splitNumeroCompra(numero);
      if(uasg !== UASG_FIXA){ log(`(info) UASG no número informado parece ser ${uasg}, mas a UASG fixa é ${UASG_FIXA}.`); }

      const resultados = await buscarPorNumero(base, numero);
      if(!resultados || resultados.length===0){
        els.saidaCompra.textContent = '// nenhum registro encontrado para este número';
        els.status.innerHTML = '<span class="err">Nenhum dado encontrado</span>';
        return;
      }

      const materiais = resultados.filter(r => (r._fonte||'').includes('materiais'));
      const servicos  = resultados.filter(r => (r._fonte||'').includes('servicos'));

      if(materiais.length){
        pretty(els.saidaMateriais, materiais);
        const detalhes = await detalharMateriais(base, materiais);
        if(detalhes.length){
          els.saidaCompra.textContent = JSON.stringify({ resumo: { numeroCompra: numero, uasg: UASG_FIXA }, detalhesMateriais: detalhes }, null, 2);
        } else {
          els.saidaCompra.textContent = JSON.stringify({ resumo: { numeroCompra: numero, uasg: UASG_FIXA }, lista: materiais }, null, 2);
        }
      }

      if(servicos.length){
        pretty(els.saidaServicos, servicos);
        if(els.saidaCompra.textContent.startsWith('{')){
          const obj = JSON.parse(els.saidaCompra.textContent);
          obj.listaServicos = servicos;
          els.saidaCompra.textContent = JSON.stringify(obj, null, 2);
        } else {
          els.saidaCompra.textContent = JSON.stringify({ resumo: { numeroCompra: numero, uasg: UASG_FIXA }, listaServicos: servicos }, null, 2);
        }
      }

      els.status.innerHTML = `<span class="ok">Concluído</span>`;
    }catch(e){
      els.status.innerHTML = `<span class="err">Erro: ${e.message}</span>`;
      log(`Erro geral: ${e.stack||e.message}`);
    }
  });

  // Testes de sanidade da página (não altere a lógica principal)
  function tlog(txt){ els.testsOut.textContent += txt + "\n"; }
  function assert(cond, msg){ if(!cond) throw new Error(msg); }
  async function runTests(){
    try{
      els.testsOut.textContent = '';
      tlog('# Sanidade PATHS');
      assert(typeof PATHS === 'object', 'PATHS não é objeto');
      assert('uasg' in PATHS && PATHS.uasg, 'PATHS.uasg ausente');
      assert('materiais' in PATHS && PATHS.materiais, 'PATHS.materiais ausente');
      assert('materialDetalhe' in PATHS && PATHS.materialDetalhe, 'PATHS.materialDetalhe ausente');
      assert('servicos' in PATHS && PATHS.servicos, 'PATHS.servicos ausente');
      assert('contratarPorNumero' in PATHS, 'PATHS.contratarPorNumero ausente');
      tlog('✓ PATHS OK');

      tlog('\n# Funções utilitárias');
      const q = qs({ a:1, b:'', c:null, d:undefined, e:'x' });
      assert(q === 'a=1&e=x' || q === 'e=x&a=1', 'qs não está filtrando vazios corretamente');
      tlog('✓ qs OK');

      const proxy = 'http://localhost:3000/proxy?url=';
      const built = (function(){
        const old = document.getElementById('proxyBase').value;
        document.getElementById('proxyBase').value = proxy;
        const u = buildUrl('https://exemplo.tld','/rota',{p:1});
        document.getElementById('proxyBase').value = old;
        return u;
      })();
      assert(built.startsWith(proxy), 'buildUrl não aplicou proxy');
      tlog('✓ buildUrl com proxy OK');

      tlog('\nTodos os testes passaram.');
    } catch(err){
      tlog('FALHA: '+err.message);
    }
  }
  if(els.btnTests){ els.btnTests.addEventListener('click', runTests); }
</script>
</body>
</html>
