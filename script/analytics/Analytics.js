/**
 * Analytics.js - Script principal para processamento de dados anal√≠ticos do Boletim PCA 2025
 * 
 * Este script √© respons√°vel por:
 *  - Carregar os dados do CSV da planilha do PCA 2025
 *  - Processar os dados para gerar m√©tricas e estat√≠sticas
 *  - Coordenar a exibi√ß√£o das se√ß√µes da p√°gina de Dados Anal√≠ticos
 *
 * =============== ESTRUTURA PRINCIPAL ================
 * 
 * # Objeto de Dados: analyticData
 * Armazena todos os dados processados, incluindo:
 *   - statusCounts: Contador de projetos por status
 *   - tipoCounts: Contador por tipo de projeto (Aquisi√ß√£o/Renova√ß√£o)
 *   - valorTotal: Somas por categoria or√ßament√°ria
 *   - situacional: Contadores para situa√ß√µes espec√≠ficas
 *   - areaCounts: Contador de projetos por √°rea
 *   - projetosPorArea: Projetos organizados por √°rea
 *   - projetosPorCategoria: Listas por tipo de or√ßamento
 *   - projetosPorSituacao: Listas por situa√ß√£o processual
 * 
 * # Fun√ß√µes Principais:
 *   - initAnalytics(): Inicia o processamento, coordena o fluxo
 *   - fetchCSVData(): Busca e processa dados CSV
 *   - processData(): Transforma dados brutos em m√©tricas
 *   - resetAnalyticData(): Limpa contadores para novo processamento
 *   - processProjectCounters(): Classifica e conta projetos
 *   - classifyProjectBySituation(): Categoriza projetos por situa√ß√£o
 *   - formatCurrency(): Formata valores monet√°rios
 * 
 * # Fluxo de Execu√ß√£o:
 *   1. O script inicia quando o DOM carrega
 *   2. Dados CSV s√£o baixados e processados
 *   3. M√©tricas s√£o calculadas e classificadas
 *   4. Interface √© renderizada com os dados
 *   5. Event listeners s√£o configurados
 * 
 * # L√≥gica de Neg√≥cio:
 *   - Projetos cancelados s√£o exclu√≠dos da an√°lise
 *   - Dados s√£o segregados por tipo (aquisi√ß√£o/renova√ß√£o)
 *   - Valores s√£o separados por or√ßamento (custeio/investimento)
 *   - Situa√ß√µes espec√≠ficas s√£o identificadas e contabilizadas
 *   - √Åreas organizacionais t√™m suas contrata√ß√µes mapeadas
 * 
 * # Depend√™ncias:
 *   - Papa Parse: Para processamento de CSV
 *   - Fun√ß√µes de renderiza√ß√£o (em outros arquivos)
 *   - Fun√ß√µes de tooltip para detalhes de contratos
 *   - Event listeners para interatividade
 */

// URL da planilha CSV (mesma do main.js) - inicial 2025 apontando para Apps Script atualizado
// Ajuste: se o ano 2026 j√° estiver selecionado antes do YearSelector inicializar,
// usamos diretamente a nova fonte (Apps Script 2026) solicitada pelo usu√°rio.
// URLs prim√°rias e redundantes (backup) para analytics
const ANALYTICS_URLS = {
    '2025': {
        main: 'https://docs.google.com/spreadsheets/d/e/2PACX-1vSkrLcVYUAyDdf3XlecZ-qdperC8emYWp_5MCXXBG_SdrF5uGab5ugtebjA9iOWeDIbyC56s9jRGjcP/pub?gid=1123542137&single=true&output=csv',
        backup: 'https://script.google.com/macros/s/AKfycbz4sHQdov5Yc26OIEga8Mg5yThXdm2SF1UMF7cG8rXPW49Z1s-KDoGh8yjCkOVKpFzUAQ/exec'
    },
    '2026': {
        main: 'https://docs.google.com/spreadsheets/d/e/2PACX-1vRcOu9JPRm1oGxkBBEgpZ-hOfictNMZblU1qATZqosqAbMc6bbUASRNRyXVe-dWAK9gGJwvg-jduUFv/pub?gid=1123542137&single=true&output=csv',
        backup: 'https://script.google.com/macros/s/AKfycbzQwBm8v7PCrSE6UbqezxD6dLYymPA6dhL64Eoy82FAdoGO26yhh6XlfaC8SlVwtY_uYw/exec'
    }
};
let SHEET_CSV_URL = (function(){
    try { const storedYear = localStorage.getItem('selectedYear'); if (storedYear && ANALYTICS_URLS[storedYear]) return ANALYTICS_URLS[storedYear].main; } catch(e) {}
    return ANALYTICS_URLS['2025'].main;
})();

// Objeto para armazenar os dados processados
const analyticData = {
    statusCounts: {},
    tipoCounts: {
        "üõí Aquisi√ß√£o": 0,
        "üîÑ Renova√ß√£o": 0
    },
    valorTotal: {
        custeio: 0,
        investimento: 0,
        custoAquisicao: 0, 
        custoRenovacao: 0,
        investimentoAquisicao: 0,
        investimentoRenovacao: 0
    },
    situacional: {
        contratacaoForaSTI: 0,
        autuacaoAtrasada: 0,
        elaboracaoInterna: 0,
        contratacaoAtrasadaForaSTI: 0,
        processosConcluidos: 0,
        processosSuspensos: 0,
        processosAIniciar: 0,
        total: 0
    },    areaCounts: {},
    projetosPorArea: {}, // Adicionar esta linha
    // Armazenar detalhes de projetos por categoria
    projetosPorCategoria: {
        custeio: [],
        investimento: [],
        custoAquisicao: [],
        custoRenovacao: [],
        investimentoAquisicao: [],
        investimentoRenovacao: []
    },
    // Armazenar detalhes de projetos por status
    projetosPorStatus: {},
    // Armazenar detalhes de projetos por tipo
    projetosPorTipo: {
        "üõí Aquisi√ß√£o": [],
        "üîÑ Renova√ß√£o": []
    },
    // Armazenar detalhes de projetos por categoria situacional
    projetosPorSituacao: {
        contratacaoForaSTI: [],
        autuacaoAtrasada: [],
        elaboracaoInterna: [],
        contratacaoAtrasadaForaSTI: [],
        processosConcluidos: [],
        processosSuspensos: [],
        processosAIniciar: []
    },
    // Lista completa de projetos (n√£o cancelados) para uso em an√°lises espec√≠ficas (ex.: pareceres jur√≠dicos)
    todosProjetos: []
};

/**
 * Fun√ß√£o para inicializar o processamento dos dados anal√≠ticos
 */
function initAnalytics() {
    const overlay = document.getElementById('loading-overlay');
    if (overlay) {
        overlay.classList.remove('d-none');
        overlay.classList.add('d-flex');
    }
    
    fetchCSVData()
        .then(processData)        .then(() => {            renderGeneralSection();
            renderOrcamentoSection();
            renderSituacionalSection();
            
            // Renderizar se√ß√£o de produtividade
            const container = document.getElementById('analytics-dashboard');
            if (container && typeof renderProdutividadeDetalhada === 'function') {
                container.innerHTML += renderProdutividadeDetalhada();
            }
            
            // REMOVIDO: Inicializa√ß√£o autom√°tica da se√ß√£o 3.2 Processos por Setor
            // Agora √© carregada sob demanda via bot√£o "Gerar Informa√ß√£o"
            console.log('[Analytics] Se√ß√£o 3.2 (Processos por Setor) configurada para carregamento sob demanda');
            
            // Atualizar a data de atualiza√ß√£o
            document.getElementById('data-atualizacao').textContent = new Date().toLocaleDateString('pt-BR');
            
            // Ocultar overlay de carregamento
            if (overlay) {
                setTimeout(() => {
                    overlay.classList.remove('d-flex');
                    overlay.classList.add('d-none');
                }, 500);
            }
              // Adicionar os event listeners para expandir/contrair detalhes
            addExpandListeners();
            // Adicionar os event listeners para a se√ß√£o situacional
            addSituacionalExpandListeners();
            // Adicionar os event listeners para os bot√µes de √°rea
            addAreaExpandListeners();
            // Adicionar os event listeners para os bot√µes de √°rea e valor
            addAreaValorExpandListeners();
            // Adicionar os event listeners para status e tipos
            addStatusExpandListeners();
            addTipoExpandListeners();
            // Adicionar os event listeners para os bot√µes de produtividade
            if (typeof addProdutividadeExpandListeners === 'function') {
                addProdutividadeExpandListeners();
            }            // Chamar setup de tooltips de contrato ap√≥s renderiza√ß√£o inicial e configura√ß√£o de listeners
            console.log('üîç Analytics.js: Tentando chamar setupAnalyticsTooltips...');
            if (typeof window.setupAnalyticsTooltips === 'function') {
                console.log('üîç Analytics.js: setupAnalyticsTooltips existe, chamando agora...');
                window.setupAnalyticsTooltips();
            } else {
                console.error('üîç Analytics.js: setupAnalyticsTooltips n√£o est√° dispon√≠vel!');
            }
        })        .catch(err => {
            console.error('Erro ao processar dados anal√≠ticos:', err);
            if (overlay) {
                overlay.classList.remove('d-flex');
                overlay.classList.add('d-none');
            }
            alert('Erro ao carregar dados anal√≠ticos. Por favor, tente novamente mais tarde.');
        });
}

/**
 * Fun√ß√£o para buscar os dados do CSV
 * @returns {Promise} Promise contendo os dados brutos do CSV
 */
function fetchCSVData() {
    return new Promise((resolve, reject) => {
        let year = '2025';
        if (window.getSelectedYear) year = window.getSelectedYear();
        const urlPack = ANALYTICS_URLS[year] || ANALYTICS_URLS['2025'];
        SHEET_CSV_URL = urlPack.main;
        const papaBase = { header: false, skipEmptyLines: true };
        const exec = window.fetchCsvWithFallback ?
            window.fetchCsvWithFallback(urlPack.main, urlPack.backup, papaBase) :
            new Promise((res, rej) => {
                Papa.parse(urlPack.main, { download: true, ...papaBase, complete: r=>res({urlUsed:urlPack.main, results:r}), error:rej });
            });
        exec.then(({ results, urlUsed }) => {
            const allRows = results.data || [];
            const headerRowIndex = allRows.findIndex(row => row && row.length > 2 && row[2] && String(row[2]).trim() === 'ID PCA');
            if (headerRowIndex < 0) return reject('Cabe√ßalho "ID PCA" n√£o encontrado no CSV');
            const headerRow = allRows[headerRowIndex];
            const dataRows = allRows.slice(headerRowIndex + 1);
            let lastValidIndex = -1;
            dataRows.forEach((row,i)=>{ if(row && row.length>5 && row[5] && String(row[5]).trim()!=='') lastValidIndex = i; });
            const validDataRows = dataRows.slice(0, lastValidIndex + 1);
            console.info('Analytics CSV carregado via', urlUsed.includes('script.google') ? 'backup' : 'prim√°rio');
            resolve({ headers: headerRow, data: validDataRows });
        }).catch(err => reject('Erro ao baixar/processar o CSV (fallback): '+ err));
    });
}

/**
 * Fun√ß√£o para processar os dados brutos do CSV
 * @param {Object} rawData Objeto contendo headers e data
 */
function processData(rawData) {    // Mapear √≠ndices das colunas necess√°rias
    const columnIndices = {
        idPca: 2,        // Coluna C - ID PCA
        area: 3,         // Coluna D - √Årea
        tipo: 4,         // Coluna E - Tipo (üõí Aquisi√ß√£o / üîÑ Renova√ß√£o)
        projeto: 5,      // Coluna F - Projeto de Aquisi√ß√£o
        statusProcesso: 6, // Coluna G - Status do Processo
        numProcesso: 13, // Coluna M - N√∫mero do Processo
        orcamento: 14,   // Coluna O - Or√ßamento
        valorPca: 15,    // Coluna P - Valor PCA
        dataProcesso: 9,  // Coluna J - Data do processo
        dataInicio: 8,    // Coluna I - Data de in√≠cio (AUTUAR EM:)
        diasAtraso: 11,  // Coluna L - Dias de atraso para autua√ß√£o
    numeroContrato: 21, // Coluna V - N√∫mero do Contrato
    numeroRegistro: 22,  // Coluna W - N√∫mero de Registro do Contrato
    modalidadeX: 23,   // Coluna X - Modalidade (para Comprasgov)
    numeroY: 24        // Coluna Y - N√∫mero/Identificador (para Comprasgov)
    };
    
    // Resetar contadores e arrays
    resetAnalyticData();
    
    // Processar cada linha de dados
    rawData.data.forEach(row => {
        if (!row || row.length < 16) return; // Pular linhas muito curtas
        
        const idPca = row[columnIndices.idPca] || '';
        const area = row[columnIndices.area] || '';
        const tipo = row[columnIndices.tipo] || '';
        const projeto = row[columnIndices.projeto] || '';
        const statusProcesso = row[columnIndices.statusProcesso] || '';
        const numProcesso = row[columnIndices.numProcesso] || '';
        const orcamento = row[columnIndices.orcamento] || '';
        const valorStr = String(row[columnIndices.valorPca] || '0')
            .replace('R$', '')
            .replace(/\./g, '')
            .replace(/,/g, '.')
            .trim();
        const valor = parseFloat(valorStr) || 0;
        const dataProcesso = row[columnIndices.dataProcesso] || '';        const dataInicio = row[columnIndices.dataInicio] || ''; // Capturando a data de in√≠cio
        const diasAtraso = row[columnIndices.diasAtraso] || ''; // Capturando os dias de atraso (coluna L)
    const numeroContrato = String(row[columnIndices.numeroContrato] || '').trim();
    const numeroRegistro = String(row[columnIndices.numeroRegistro] || '').trim();
    const modalidadeX = String(row[columnIndices.modalidadeX] || '').trim();
    const numeroY = String(row[columnIndices.numeroY] || '').trim();
        
        // Criar objeto de projeto para uso em detalhamentos
        const projetoObj = {
            idPca,
            area,
            projeto,
            valor,
            numProcesso,
            tipo,      // Adicionando o tipo ao objeto
            status: statusProcesso, // Adicionando o status ao objeto
            i: dataInicio,   // Apenas armazenando a data de in√≠cio (coluna I - AUTUAR EM)
            dataProcesso, // Adicionar esta linha para incluir a data de "Contratar At√©"
            diasAtraso,   // Adicionar os dias de atraso para status "AUTUA√á√ÉO ATRASADA üí£"
            numeroContrato, // Adicionar n√∫mero do contrato
            numeroRegistro,  // Adicionar n√∫mero de registro
            modalidadeX,    // Modalidade (X) para Comprasgov
            numeroY         // N√∫mero (Y) para Comprasgov
        };
        
        // Processar contadores e categorias
        processProjectCounters(projetoObj, statusProcesso, tipo, orcamento, area);
        
        // Classificar projetos por situa√ß√£o
        classifyProjectBySituation(projetoObj, statusProcesso, area);
    });
    
    return Promise.resolve();
}

/**
 * Fun√ß√£o para resetar todos os contadores e arrays de dados
 */
function resetAnalyticData() {
    analyticData.statusCounts = {};
    analyticData.tipoCounts = {
        "üõí Aquisi√ß√£o": 0,
        "üîÑ Renova√ß√£o": 0
    };
    analyticData.valorTotal = {
        custeio: 0,
        investimento: 0,
        custoAquisicao: 0, 
        custoRenovacao: 0,
        investimentoAquisicao: 0,
        investimentoRenovacao: 0
    };
    analyticData.situacional = {
        contratacaoForaSTI: 0,
        autuacaoAtrasada: 0,
        elaboracaoInterna: 0,
        contratacaoAtrasadaForaSTI: 0,
        processosConcluidos: 0,
        processosSuspensos: 0,
        processosAIniciar: 0,
        total: 0
    };
    analyticData.areaCounts = {};
    analyticData.projetosPorArea = {}; // Adicionar esta linha
      // Limpar arrays de projetos por categoria
    analyticData.projetosPorCategoria = {
        custeio: [],
        investimento: [],
        custoAquisicao: [],
        custoRenovacao: [],
        investimentoAquisicao: [],
        investimentoRenovacao: []
    };
    
    // Limpar arrays de projetos por status
    analyticData.projetosPorStatus = {};
    
    // Limpar arrays de projetos por tipo
    analyticData.projetosPorTipo = {
        "üõí Aquisi√ß√£o": [],
        "üîÑ Renova√ß√£o": []
    };
    
    // Limpar arrays de projetos por categoria situacional
    analyticData.projetosPorSituacao = {
        contratacaoForaSTI: [],
        autuacaoAtrasada: [],
        elaboracaoInterna: [],
        contratacaoAtrasadaForaSTI: [],
        processosConcluidos: [],
        processosSuspensos: [],
        processosAIniciar: []
    };
    analyticData.todosProjetos = [];
}

/**
 * Fun√ß√£o para processar contadores e categorizar projetos
 */
function processProjectCounters(projetoObj, statusProcesso, tipo, orcamento, area) {
    // N√£o processar projetos cancelados ou sem tipo v√°lido
    if (statusProcesso === 'CANCELADO ‚ùå' || (tipo !== 'üõí Aquisi√ß√£o' && tipo !== 'üîÑ Renova√ß√£o')) {
        return; // Pular este projeto completamente
    }
    // Registrar projeto na lista completa (para an√°lises que precisam de todos os projetos eleg√≠veis independentemente de ter status contabilizado)
    analyticData.todosProjetos.push(projetoObj);
      // Contar status
    if (statusProcesso) {
        analyticData.statusCounts[statusProcesso] = (analyticData.statusCounts[statusProcesso] || 0) + 1;
        
        // Adicionar projeto ao array de projetos por status
        if (!analyticData.projetosPorStatus[statusProcesso]) {
            analyticData.projetosPorStatus[statusProcesso] = [];
        }
        analyticData.projetosPorStatus[statusProcesso].push({
            id: projetoObj.idPca,
            area: projetoObj.area,
            objeto: projetoObj.projeto,
            contratar_ate: projetoObj.dataProcesso,
            valor: projetoObj.valor,
            numeroProcesso: projetoObj.numProcesso,
            numeroContrato: projetoObj.numeroContrato,
            numeroRegistro: projetoObj.numeroRegistro,
            modalidadeX: projetoObj.modalidadeX,
            numeroY: projetoObj.numeroY
        });
        
        analyticData.situacional.total++;
    }
    
    // Contar tipos (Aquisi√ß√£o/Renova√ß√£o)
    if (tipo === 'üõí Aquisi√ß√£o') {
        analyticData.tipoCounts["üõí Aquisi√ß√£o"]++;
        analyticData.projetosPorTipo["üõí Aquisi√ß√£o"].push({
            id: projetoObj.idPca,
            area: projetoObj.area,
            objeto: projetoObj.projeto,
            contratar_ate: projetoObj.dataProcesso,
            valor: projetoObj.valor,
            numeroProcesso: projetoObj.numProcesso,
            numeroContrato: projetoObj.numeroContrato,
            numeroRegistro: projetoObj.numeroRegistro,
            modalidadeX: projetoObj.modalidadeX,
            numeroY: projetoObj.numeroY
        });
    } else if (tipo === 'üîÑ Renova√ß√£o') {
        analyticData.tipoCounts["üîÑ Renova√ß√£o"]++;
        analyticData.projetosPorTipo["üîÑ Renova√ß√£o"].push({
            id: projetoObj.idPca,
            area: projetoObj.area,
            objeto: projetoObj.projeto,
            contratar_ate: projetoObj.dataProcesso,
            valor: projetoObj.valor,
            numeroProcesso: projetoObj.numProcesso,
            numeroContrato: projetoObj.numeroContrato,
            numeroRegistro: projetoObj.numeroRegistro,
            modalidadeX: projetoObj.modalidadeX,
            numeroY: projetoObj.numeroY
        });
    }
    
    // Calcular valores totais por or√ßamento e tipo
    if (orcamento.includes('CUSTEIO')) {
        analyticData.valorTotal.custeio += projetoObj.valor;
        analyticData.projetosPorCategoria.custeio.push(projetoObj);
        
        if (tipo === 'üõí Aquisi√ß√£o') {
            analyticData.valorTotal.custoAquisicao += projetoObj.valor;
            analyticData.projetosPorCategoria.custoAquisicao.push(projetoObj);
        } else if (tipo === 'üîÑ Renova√ß√£o') {
            analyticData.valorTotal.custoRenovacao += projetoObj.valor;
            analyticData.projetosPorCategoria.custoRenovacao.push(projetoObj);
        }
    } else if (orcamento.includes('INVESTIMENTO')) {
        analyticData.valorTotal.investimento += projetoObj.valor;
        analyticData.projetosPorCategoria.investimento.push(projetoObj);
        
        if (tipo === 'üõí Aquisi√ß√£o') {
            analyticData.valorTotal.investimentoAquisicao += projetoObj.valor;
            analyticData.projetosPorCategoria.investimentoAquisicao.push(projetoObj);
        } else if (tipo === 'üîÑ Renova√ß√£o') {
            analyticData.valorTotal.investimentoRenovacao += projetoObj.valor;
            analyticData.projetosPorCategoria.investimentoRenovacao.push(projetoObj);
        }
    }
    
    // Contagem por √°rea e adi√ß√£o √† lista de projetos da √°rea
    if (area) {
        if (!analyticData.areaCounts[area]) {
            analyticData.areaCounts[area] = {
                "üõí Aquisi√ß√£o": 0,
                "üîÑ Renova√ß√£o": 0,
                total: 0
            };
        }
        if (!analyticData.projetosPorArea[area]) {
            analyticData.projetosPorArea[area] = [];
        }

        if (projetoObj.tipo === 'üõí Aquisi√ß√£o') {
            analyticData.areaCounts[area]["üõí Aquisi√ß√£o"]++;
            analyticData.projetosPorArea[area].push(projetoObj);
        } else if (projetoObj.tipo === 'üîÑ Renova√ß√£o') {
            analyticData.areaCounts[area]["üîÑ Renova√ß√£o"]++;
            analyticData.projetosPorArea[area].push(projetoObj);
        }
        analyticData.areaCounts[area].total++;
    }
}

/**
 * Fun√ß√£o para classificar projetos por situa√ß√£o
 */
function classifyProjectBySituation(projetoObj, statusProcesso, area) {
    // N√£o processar projetos cancelados ou sem tipo v√°lido
    if (statusProcesso === 'CANCELADO ‚ùå' || (projetoObj.tipo !== 'üõí Aquisi√ß√£o' && projetoObj.tipo !== 'üîÑ Renova√ß√£o')) {
        return; // Pular este projeto completamente
    }
    
    // Contrata√ß√£o fora da STI
    if (statusProcesso === 'EM CONTRATA√á√ÉO ü§ù' || statusProcesso === 'EM RENOVA√á√ÉO üîÑ') {
        analyticData.situacional.contratacaoForaSTI++;
        analyticData.projetosPorSituacao.contratacaoForaSTI.push(projetoObj);
    }
    
    // Autua√ß√£o atrasada
    if (statusProcesso.includes('AUTUA√á√ÉO ATRASADA')) {
        analyticData.situacional.autuacaoAtrasada++;
        analyticData.projetosPorSituacao.autuacaoAtrasada.push(projetoObj);
    }
    
    // Elabora√ß√£o interna de artefatos
    if (
        statusProcesso.includes('DFD ATRASADO') ||
        statusProcesso.includes('ETP ATRASADO') ||
        statusProcesso.includes('AGUARDANDO ETP') ||
        statusProcesso.includes('ELABORANDO TR') ||
        statusProcesso.includes('AN√ÅLISE DE VIABILIDADE') ||
        statusProcesso.includes('AGUARDANDO DFD')
    ) {
        analyticData.situacional.elaboracaoInterna++;
        analyticData.projetosPorSituacao.elaboracaoInterna.push(projetoObj);
    }
      // Contrata√ß√£o atrasada fora da STI
    if (statusProcesso.includes('CONTRATA√á√ÉO ATRASADA')) {
        analyticData.situacional.contratacaoAtrasadaForaSTI++;
        analyticData.projetosPorSituacao.contratacaoAtrasadaForaSTI.push(projetoObj);
    }
    
    // Processos conclu√≠dos
    if (statusProcesso.includes('CONTRATADO') || statusProcesso.includes('RENOVADO')) {
        analyticData.situacional.processosConcluidos++;
        analyticData.projetosPorSituacao.processosConcluidos.push(projetoObj);
    }
    
    // Processos suspensos
    if (statusProcesso.includes('REVIS√ÉO PCA')) {
        analyticData.situacional.processosSuspensos++;
        analyticData.projetosPorSituacao.processosSuspensos.push(projetoObj);
    }
    
    // Processos a iniciar
    if (statusProcesso.includes('A INICIAR')) {
        analyticData.situacional.processosAIniciar++;
        analyticData.projetosPorSituacao.processosAIniciar.push(projetoObj);
    }
}

/**
 * Fun√ß√£o auxiliar para formatar valores monet√°rios
 * @param {number} value Valor a ser formatado
 * @returns {string} Valor formatado como moeda
 */
function formatCurrency(value) {
    // Verifica se o valor √© um n√∫mero antes de formatar
    if (typeof value !== 'number') {
        return value; // Retorna o valor original se n√£o for um n√∫mero
    }
    return value.toLocaleString('pt-BR', {
        minimumFractionDigits: 2, // Mant√©m no m√≠nimo 2 casas decimais
        // Removido maximumFractionDigits para permitir mais casas decimais se necess√°rio
    });
}

// Inicializar quando o DOM estiver pronto
document.addEventListener('DOMContentLoaded', initAnalytics);

// Fun√ß√£o para recarregar dados anal√≠ticos dinamicamente ao mudar de ano
window.reloadAnalyticsForYear = function(newYear) {
    try {
        // Atualiza armazenamento e config global se existir
        localStorage.setItem('selectedYear', newYear);
        if (window.yearSelectorConfig) {
            window.yearSelectorConfig.currentYear = newYear;
        }
        // Atualizar t√≠tulo e header da p√°gina anal√≠tica
        const title = document.querySelector('title');
        if (title) {
            title.textContent = title.textContent.replace(/(2025|2026)/, newYear);
        }
        const header = document.querySelector('h1');
        if (header && header.textContent.includes('Relat√≥rio Anal√≠tico')) {
            header.textContent = header.textContent.replace(/(2025|2026)/, newYear);
        }
        // Limpa o dashboard antes de recarregar
        const container = document.getElementById('analytics-dashboard');
        if (container) container.innerHTML = '';
        // Reexecuta pipeline
        initAnalytics();
    } catch (e) {
        console.error('Erro ao recarregar analytics para ano', newYear, e);
    }
};